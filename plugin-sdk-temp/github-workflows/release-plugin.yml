name: Build & Release Plugin

on:
  workflow_dispatch:
    inputs: 
      plugin_name:
        description: 'Plugin to build (e.g., barcode, network, password)'
        required: true
        type: choice
        options:
          - barcode
          - bluetooth
          - calendar
          - deviceinfo
          - dnstools
          - dvd
          - network
          - ntp
          - password
          - scanner
          - secure-notes
      version:
        description: 'Version number (e.g., 1.2.0)'
        required: true
        type: string

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Set up Rust (if needed)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android,i686-linux-android
        continue-on-error: true
      
      - name: Install cargo-ndk (if Rust needed)
        run: cargo install cargo-ndk
        continue-on-error: true
      
      - name: Set up Android NDK (if Rust needed)
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26
        continue-on-error: true
      
      - name: Build Rust libraries (if exists)
        working-directory: connectias-plugin-${{ github.event.inputs.plugin_name }}/src/main/rust
        run: |
          cargo ndk --target aarch64-linux-android --platform 33 -- build --release
        continue-on-error: true
      
      - name: Build Plugin AAB
        run: |
          ./gradlew :connectias-plugin-${{ github.event.inputs.plugin_name }}:bundleRelease --no-daemon
      
      - name: Sign AAB
        env:
          SIGNING_KEY: ${{ secrets.PLUGIN_SIGNING_KEY }}
          KEY_ALIAS: ${{ secrets.PLUGIN_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.PLUGIN_KEY_PASSWORD }}
        run: |
          if [ -n "$SIGNING_KEY" ]; then
            echo "$SIGNING_KEY" | base64 -d > signing.jks
            
            jarsigner -verbose -sigalg SHA256withRSA \
              -digestalg SHA256 \
              -keystore signing.jks \
              -storepass "$KEY_PASSWORD" \
              -keypass "$KEY_PASSWORD" \
              connectias-plugin-${{ github.event.inputs.plugin_name }}/build/outputs/bundle/release/connectias-plugin-${{ github.event.inputs.plugin_name }}-release.aab \
              "$KEY_ALIAS"
          else
            echo "Warning: Signing key not configured, skipping signing"
          fi
        continue-on-error: true
      
      - name: Generate SHA256 Checksum
        run: |
          sha256sum connectias-plugin-${{ github.event.inputs.plugin_name }}/build/outputs/bundle/release/connectias-plugin-${{ github.event.inputs.plugin_name }}-release.aab > sha256sum.txt
      
      - name: Copy Manifest
        run: |
          cp connectias-plugin-${{ github.event.inputs.plugin_name }}/src/main/resources/plugin-manifest.json . || echo "Warning: plugin-manifest.json not found"
        continue-on-error: true
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with: 
          tag_name: v${{ github.event.inputs.version }}-${{ github.event.inputs.plugin_name }}
          name: ${{ github.event.inputs.plugin_name }} v${{ github.event.inputs.version }}
          body: |
            # ${{ github.event.inputs.plugin_name }} v${{ github.event.inputs.version }}
            
            Release notes automatically generated. Update this with changelog details.
            
            ## Plugin Info
            ```json
            $(cat plugin-manifest.json 2>/dev/null || echo '{}')
            ```
          files: |
            connectias-plugin-${{ github.event.inputs.plugin_name }}/build/outputs/bundle/release/connectias-plugin-${{ github.event.inputs.plugin_name }}-release.aab
            plugin-manifest.json
            sha256sum.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: Release Changed Plugins

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version for changed plugins (e.g., 1.0.0)'
        required: true
        type: string
      force_all:
        description: 'Force build all plugins (ignore changes)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      ping-plugin: ${{ steps.changes.outputs.ping-plugin }}
      test-plugin: ${{ steps.changes.outputs.test-plugin }}
      network-info-plugin: ${{ steps.changes.outputs.network-info-plugin }}
      changed-plugins: ${{ steps.changes.outputs.changed-plugins }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for change detection
      
      - name: Detect changed plugins
        id: changes
        run: |
          # Get all plugin directories
          PLUGINS=("ping-plugin" "test-plugin" "network-info-plugin")
          CHANGED_PLUGINS=()
          
          # If force_all is true, mark all as changed
          if [ "${{ github.event.inputs.force_all }}" == "true" ]; then
            echo "Force build all plugins enabled"
            for plugin in "${PLUGINS[@]}"; do
              echo "${plugin}=true" >> $GITHUB_OUTPUT
              CHANGED_PLUGINS+=("${plugin}")
            done
            echo "changed-plugins=$(IFS=','; echo "${CHANGED_PLUGINS[*]}")" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check changes for each plugin
          for plugin in "${PLUGINS[@]}"; do
            PLUGIN_DIR="${plugin}"
            
            # Find latest tag for this specific plugin
            # Tag format: v{version}-{plugin-name}
            LATEST_PLUGIN_TAG=$(git tag -l "v*-${plugin}" | sort -V | tail -1)
            
            if [ -z "$LATEST_PLUGIN_TAG" ]; then
              # No previous release for this plugin, mark as changed
              echo "No previous release for ${plugin}, marking as changed"
              echo "${plugin}=true" >> $GITHUB_OUTPUT
              CHANGED_PLUGINS+=("${plugin}")
            else
              # Check if plugin directory or root build files changed since last tag
              echo "Checking ${plugin} against tag ${LATEST_PLUGIN_TAG}"
              
              # Check for changes in:
              # - Plugin directory (specific changes)
              # - Root build.gradle.kts (affects all plugins)
              # - settings.gradle.kts (affects all plugins)
              # - gradle/ directory (affects all plugins)
              # - gradle.properties (affects all plugins)
              
              # First check if plugin-specific files changed
              PLUGIN_CHANGED=$(git diff --name-only ${LATEST_PLUGIN_TAG}..HEAD -- "${PLUGIN_DIR}/" || echo "")
              
              # Check if common build files changed (affect all plugins)
              COMMON_CHANGED=$(git diff --name-only ${LATEST_PLUGIN_TAG}..HEAD -- \
                "build.gradle.kts" \
                "settings.gradle.kts" \
                "gradle/" \
                "gradle.properties" || echo "")
              
              if [ -n "$PLUGIN_CHANGED" ]; then
                echo "Plugin-specific changes detected in ${plugin}:"
                echo "$PLUGIN_CHANGED"
                echo "${plugin}=true" >> $GITHUB_OUTPUT
                CHANGED_PLUGINS+=("${plugin}")
              elif [ -n "$COMMON_CHANGED" ]; then
                echo "Common build files changed, rebuilding ${plugin}:"
                echo "$COMMON_CHANGED"
                echo "${plugin}=true" >> $GITHUB_OUTPUT
                CHANGED_PLUGINS+=("${plugin}")
              else
                echo "No changes detected for ${plugin}"
                echo "${plugin}=false" >> $GITHUB_OUTPUT
              fi
            fi
          done
          
          if [ ${#CHANGED_PLUGINS[@]} -eq 0 ]; then
            echo "No plugins changed, nothing to build"
            echo "changed-plugins=" >> $GITHUB_OUTPUT
          else
            echo "Changed plugins: ${CHANGED_PLUGINS[*]}"
            echo "changed-plugins=$(IFS=','; echo "${CHANGED_PLUGINS[*]}")" >> $GITHUB_OUTPUT
          fi
      
      - name: Show changed plugins
        run: |
          echo "Changed plugins: ${{ steps.changes.outputs.changed-plugins }}"
          echo "ping-plugin: ${{ steps.changes.outputs.ping-plugin }}"
          echo "test-plugin: ${{ steps.changes.outputs.test-plugin }}"
          echo "network-info-plugin: ${{ steps.changes.outputs.network-info-plugin }}"

  build-ping-plugin:
    needs: detect-changes
    if: needs.detect-changes.outputs.ping-plugin == 'true'
    uses: ./.github/workflows/release-single-plugin.yml
    with:
      plugin: ping-plugin
      version: ${{ github.event.inputs.version }}
    secrets: inherit

  build-test-plugin:
    needs: detect-changes
    if: needs.detect-changes.outputs.test-plugin == 'true'
    uses: ./.github/workflows/release-single-plugin.yml
    with:
      plugin: test-plugin
      version: ${{ github.event.inputs.version }}
    secrets: inherit

  build-network-info-plugin:
    needs: detect-changes
    if: needs.detect-changes.outputs['network-info-plugin'] == 'true'
    uses: ./.github/workflows/release-single-plugin.yml
    with:
      plugin: network-info-plugin
      version: ${{ github.event.inputs.version }}
    secrets: inherit

  summary:
    needs: [detect-changes, build-ping-plugin, build-test-plugin, build-network-info-plugin]
    if: always() && needs.detect-changes.outputs.changed-plugins != ''
    runs-on: ubuntu-latest
    steps:
      - name: Release Summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changed Plugins:" >> $GITHUB_STEP_SUMMARY
          echo "${{ needs.detect-changes.outputs.changed-plugins }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Status:" >> $GITHUB_STEP_SUMMARY
          echo "- ping-plugin: ${{ needs.build-ping-plugin.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- test-plugin: ${{ needs.build-test-plugin.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- network-info-plugin: ${{ needs.build-network-info-plugin.result }}" >> $GITHUB_STEP_SUMMARY
